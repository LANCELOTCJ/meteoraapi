<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ± å­é—ªçƒåŠŸèƒ½æµ‹è¯•</title>
    <link href="{{ url_for('static', filename='css/meteora-style.css') }}" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }

        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
        }

        .log {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .status-good {
            color: #28a745;
        }

        .status-bad {
            color: #dc3545;
        }

        .status-warning {
            color: #ffc107;
        }

        /* æµ‹è¯•ç”¨çš„æ± å­è¡¨æ ¼ */
        .test-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .test-table th,
        .test-table td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }

        .test-table th {
            background: #333;
        }

        .test-table tr:nth-child(even) {
            background: #2a2a2a;
        }
    </style>
</head>

<body>
    <h1>ğŸ”§ æ± å­é—ªçƒåŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
        <h2>æµ‹è¯•æ§åˆ¶</h2>
        <button class="btn" onclick="testWebSocketConnection()">1. æµ‹è¯•WebSocketè¿æ¥</button>
        <button class="btn" onclick="sendTestAlerts()">2. å‘é€æµ‹è¯•æŠ¥è­¦</button>
        <button class="btn" onclick="manualTestBlinking()">3. æ‰‹åŠ¨æµ‹è¯•é—ªçƒ</button>
        <button class="btn btn-success" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ± å­è¡¨æ ¼</h2>
        <table class="test-table" id="testTable">
            <thead>
                <tr>
                    <th>æ± å­åç§°</th>
                    <th>æ± å­åœ°å€</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                <tr data-address="test1AddressAIPUMPSOL">
                    <td class="cell-pool-name">AIPUMP-SOL</td>
                    <td>test1AddressAIPUMPSOL</td>
                    <td>æ­£å¸¸</td>
                </tr>
                <tr data-address="test2AddressNANISOL">
                    <td class="cell-pool-name">NANI-SOL</td>
                    <td>test2AddressNANISOL</td>
                    <td>æ­£å¸¸</td>
                </tr>
                <tr data-address="test3AddressSWARMSOL">
                    <td class="cell-pool-name">SWARM-SOL</td>
                    <td>test3AddressSWARMSOL</td>
                    <td>æ­£å¸¸</td>
                </tr>
                <tr data-address="test4AddressDUNASOL">
                    <td class="cell-pool-name">DUNA-SOL</td>
                    <td>test4AddressDUNASOL</td>
                    <td>æ­£å¸¸</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <div id="testLog" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...\n</div>
    </div>

    <!-- åŠ è½½WebSocketå®¢æˆ·ç«¯ -->
    <script src="{{ url_for('static', filename='js/websocket-client.js') }}"></script>

    <script>
        let testWebSocket = null;

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'status-bad' :
                type === 'success' ? 'status-good' :
                    type === 'warning' ? 'status-warning' : '';

            logDiv.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('testLog').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º\n';
        }

        async function testWebSocketConnection() {
            addLog('ğŸ”— å¼€å§‹æµ‹è¯•WebSocketè¿æ¥...', 'info');

            try {
                const ws = new WebSocket('ws://localhost:8765');

                ws.onopen = function () {
                    addLog('âœ… WebSocketè¿æ¥æˆåŠŸ!', 'success');
                };

                ws.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${data.type}`, 'info');

                    if (data.type === 'welcome') {
                        // è®¢é˜…alerts
                        ws.send(JSON.stringify({
                            type: 'subscribe',
                            subscription: 'alerts'
                        }));
                        addLog('ğŸ“‹ å·²å‘é€alertsè®¢é˜…è¯·æ±‚', 'info');
                    }

                    if (data.type === 'subscription_success') {
                        addLog('âœ… alertsè®¢é˜…æˆåŠŸ!', 'success');
                        testWebSocket = ws;
                    }

                    // ğŸ”§ æ–°å¢ï¼šç›‘å¬æŠ¥è­¦æ¶ˆæ¯
                    if (data.type === 'new_alert') {
                        addLog(`ğŸš¨ æ”¶åˆ°æŠ¥è­¦é€šçŸ¥: ${data.data?.pool_name}`, 'success');
                        addLog(`ğŸ“‹ æŠ¥è­¦è¯¦æƒ…: ${data.message}`, 'info');

                        // æ‰‹åŠ¨è§¦å‘æ± å­é—ªçƒæ•ˆæœ
                        if (data.data && data.data.pool_address) {
                            triggerPoolBlinking(data.data.pool_address, data.data.pool_name);
                        }
                    }
                };

                ws.onerror = function (error) {
                    addLog('âŒ WebSocketè¿æ¥é”™è¯¯: ' + error, 'error');
                };

                ws.onclose = function () {
                    addLog('ğŸ”´ WebSocketè¿æ¥å·²å…³é—­', 'warning');
                };

            } catch (error) {
                addLog('âŒ WebSocketè¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function sendTestAlerts() {
            addLog('ğŸ“¤ å¼€å§‹å‘é€æµ‹è¯•æŠ¥è­¦...', 'info');

            try {
                const testPools = [
                    { name: 'AIPUMP-SOL', address: 'test1AddressAIPUMPSOL' },
                    { name: 'NANI-SOL', address: 'test2AddressNANISOL' },
                    { name: 'SWARM-SOL', address: 'test3AddressSWARMSOL' },
                    { name: 'DUNA-SOL', address: 'test4AddressDUNASOL' }
                ];

                for (let i = 0; i < testPools.length; i++) {
                    const pool = testPools[i];

                    const alertData = {
                        pool_address: pool.address,
                        pool_name: pool.name,
                        alert_type: 'fees_hour_1',
                        change_type: 'increase',
                        change_percent: 50.0 + i * 10,
                        threshold_percent: 20.0,
                        old_value: 1000.0,
                        new_value: 1500.0 + i * 100
                    };

                    addLog(`ğŸ“¤ å‘é€æµ‹è¯•æŠ¥è­¦APIè¯·æ±‚: ${pool.name}`, 'info');

                    try {
                        const response = await fetch('/api/test/trigger-alert', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(alertData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            addLog(`âœ… ${pool.name} æŠ¥è­¦è§¦å‘æˆåŠŸ`, 'success');
                        } else {
                            addLog(`âŒ ${pool.name} æŠ¥è­¦è§¦å‘å¤±è´¥: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        addLog(`âŒ ${pool.name} APIè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                addLog('âœ… æ‰€æœ‰æµ‹è¯•æŠ¥è­¦è¯·æ±‚å·²å‘é€', 'success');
                addLog('ğŸ¯ è¯·æŸ¥çœ‹ä¸Šæ–¹è¡¨æ ¼ä¸­çš„æ± å­æ˜¯å¦æœ‰çº¢è‰²é—ªçƒæ•ˆæœ', 'warning');
                addLog('ğŸ’¡ å¦‚æœæ²¡æœ‰æ•ˆæœï¼Œè¯·æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€', 'info');

            } catch (error) {
                addLog(`âŒ å‘é€æµ‹è¯•æŠ¥è­¦å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function manualTestBlinking() {
            addLog('ğŸ§ª å¼€å§‹æ‰‹åŠ¨æµ‹è¯•é—ªçƒåŠŸèƒ½...', 'info');

            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæ± å­è¡Œ
            const firstRow = document.querySelector('#testTable tbody tr');
            if (firstRow) {
                const nameCell = firstRow.querySelector('.cell-pool-name');
                const poolName = nameCell.textContent;

                addLog(`ğŸ¯ å¯¹ ${poolName} åº”ç”¨é—ªçƒæ ·å¼`, 'info');

                // æ·»åŠ é—ªçƒæ ·å¼
                firstRow.classList.add('alert-pool-row');
                nameCell.classList.add('alert-pool-name');

                addLog('ğŸ“Œ å·²æ·»åŠ  alert-pool-row å’Œ alert-pool-name ç±»', 'info');

                // æ£€æŸ¥åŠ¨ç”»
                setTimeout(() => {
                    const computedStyle = window.getComputedStyle(nameCell);
                    const animation = computedStyle.animation || computedStyle.webkitAnimation;

                    if (animation && animation !== 'none') {
                        addLog(`âœ… åŠ¨ç”»å·²åº”ç”¨: ${animation}`, 'success');
                        addLog('ğŸ‰ å¦‚æœä½ çœ‹åˆ°æ± å­åç§°åœ¨é—ªçƒï¼Œè¯´æ˜åŠŸèƒ½æ­£å¸¸!', 'success');
                    } else {
                        addLog('âŒ åŠ¨ç”»æœªåº”ç”¨ï¼Œå¯èƒ½CSSæ ·å¼æœ‰é—®é¢˜', 'error');
                        addLog('ğŸ” è¯·æ£€æŸ¥ meteora-style.css æ–‡ä»¶ä¸­çš„åŠ¨ç”»æ ·å¼', 'warning');
                    }
                }, 100);

                // 10ç§’åç§»é™¤æ ·å¼
                setTimeout(() => {
                    firstRow.classList.remove('alert-pool-row');
                    nameCell.classList.remove('alert-pool-name');
                    addLog('ğŸ”„ å·²ç§»é™¤é—ªçƒæ ·å¼', 'info');
                }, 10000);

            } else {
                addLog('âŒ æœªæ‰¾åˆ°æµ‹è¯•è¡¨æ ¼è¡Œ', 'error');
            }
        }

        // ğŸ”§ æ–°å¢ï¼šè§¦å‘æŒ‡å®šæ± å­çš„é—ªçƒæ•ˆæœ
        function triggerPoolBlinking(poolAddress, poolName) {
            addLog(`ğŸ¯ è§¦å‘æ± å­é—ªçƒ: ${poolName} (${poolAddress})`, 'info');

            // æŸ¥æ‰¾å¯¹åº”çš„æ± å­è¡Œ
            let targetRow = document.querySelector(`tr[data-address="${poolAddress}"]`);

            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œé€šè¿‡æ± å­åç§°æŸ¥æ‰¾
            if (!targetRow) {
                const nameElements = document.querySelectorAll('.cell-pool-name');
                for (const element of nameElements) {
                    if (element.textContent.trim() === poolName) {
                        targetRow = element.closest('tr');
                        break;
                    }
                }
            }

            if (targetRow) {
                const nameCell = targetRow.querySelector('.cell-pool-name');

                addLog(`âœ… æ‰¾åˆ°ç›®æ ‡æ± å­è¡Œ: ${poolName}`, 'success');

                // æ·»åŠ é—ªçƒæ ·å¼
                targetRow.classList.add('alert-pool-row');
                if (nameCell) {
                    nameCell.classList.add('alert-pool-name');
                }

                addLog('ğŸ“Œ å·²æ·»åŠ é—ªçƒæ ·å¼', 'info');

                // æ£€æŸ¥åŠ¨ç”»
                setTimeout(() => {
                    if (nameCell) {
                        const computedStyle = window.getComputedStyle(nameCell);
                        const animation = computedStyle.animation || computedStyle.webkitAnimation;

                        if (animation && animation !== 'none') {
                            addLog(`âœ… ${poolName} åŠ¨ç”»å·²åº”ç”¨: ${animation}`, 'success');
                        } else {
                            addLog(`âš ï¸ ${poolName} åŠ¨ç”»æœªåº”ç”¨`, 'warning');
                        }
                    }
                }, 100);

                // 5åˆ†é’Ÿåç§»é™¤æ ·å¼
                setTimeout(() => {
                    targetRow.classList.remove('alert-pool-row');
                    if (nameCell) {
                        nameCell.classList.remove('alert-pool-name');
                    }
                    addLog(`ğŸ”„ å·²ç§»é™¤ ${poolName} çš„é—ªçƒæ ·å¼`, 'info');
                }, 300000); // 5åˆ†é’Ÿ

            } else {
                addLog(`âŒ æœªæ‰¾åˆ°æ± å­è¡Œ: ${poolName} (${poolAddress})`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ', 'info');
            addLog('ğŸ”§ è¯·æŒ‰é¡ºåºç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•:', 'info');
            addLog('   1. å…ˆç‚¹å‡»"æµ‹è¯•WebSocketè¿æ¥"', 'info');
            addLog('   2. è¿æ¥æˆåŠŸåç‚¹å‡»"å‘é€æµ‹è¯•æŠ¥è­¦"', 'info');
            addLog('   3. æˆ–è€…ç›´æ¥ç‚¹å‡»"æ‰‹åŠ¨æµ‹è¯•é—ªçƒ"æŸ¥çœ‹åŠ¨ç”»æ•ˆæœ', 'info');
        });
    </script>
</body>

</html>